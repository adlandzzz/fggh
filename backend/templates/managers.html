<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBGSOSAT CRM - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏</title>
    <link rel="stylesheet" href="/css/old-style.css">
    <style>
        .managers-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .manager-card {
            background: hsl(var(--card));
            border: 2px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 6px);
            padding: 2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.3s ease-out;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .manager-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .manager-card:hover {
            border-color: hsl(var(--primary) / 0.5);
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .manager-card:hover::before {
            transform: scaleX(1);
        }

        .manager-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
        }

        .manager-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .manager-status {
            padding: 0.5rem 1rem;
            border-radius: calc(var(--radius));
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-active {
            background: linear-gradient(135deg, hsl(var(--success)), hsl(var(--success) / 0.8));
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .status-inactive {
            background: hsl(var(--muted));
            color: hsl(var(--muted-foreground));
        }

        .manager-info {
            margin: 1.5rem 0;
            font-size: 0.9375rem;
            color: hsl(var(--muted-foreground));
            line-height: 1.8;
        }

        .manager-info strong {
            color: hsl(var(--foreground));
            font-weight: 600;
        }

        .manager-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1.25rem;
            background: hsl(var(--muted) / 0.5);
            border-radius: calc(var(--radius));
            border: 1px solid hsl(var(--border));
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: hsl(var(--muted-foreground));
            font-weight: 500;
        }

        .manager-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid hsl(var(--border));
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            border-radius: calc(var(--radius));
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.875rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: hsl(var(--accent));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, hsl(var(--destructive)), hsl(var(--destructive) / 0.8));
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 8px);
            padding: 2.5rem;
            max-width: 550px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease-out;
        }

        .modal-content h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: hsl(var(--foreground));
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: hsl(var(--foreground));
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: hsl(var(--primary) / 0.1);
            border-radius: 4px;
            color: hsl(var(--primary));
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: hsl(var(--input));
            border: 2px solid hsl(var(--border));
            border-radius: calc(var(--radius));
            color: hsl(var(--foreground));
            font-size: 0.9375rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
        }

        .form-input:hover {
            border-color: hsl(var(--border) / 1.2);
        }

        .form-input:focus {
            outline: none;
            border-color: hsl(var(--primary));
            box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            background: hsl(var(--input) / 1.1);
        }

        .form-input::placeholder {
            color: hsl(var(--muted-foreground) / 0.6);
        }

        .form-help {
            font-size: 0.8125rem;
            color: hsl(var(--muted-foreground));
            margin-top: 0.5rem;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/admin/dashboard" class="logo">TBGSOSAT CRM ADMIN</a>
                <nav class="nav">
                    <span style="color: var(--muted-foreground);">üëë {{ user.username }}</span>
                    <a href="/admin/dashboard" class="nav-link">üìä –î–∞—à–±–æ—Ä–¥</a>
                    <a href="/chats" class="nav-link">üí¨ –ß–∞—Ç—ã</a>
                    <a href="/shops" class="nav-link">üè™ –ú–∞–≥–∞–∑–∏–Ω—ã</a>
                    <a href="/managers" class="nav-link active">üë• –ú–µ–Ω–µ–¥–∂–µ—Ä—ã</a>
                    <a href="/analytics" class="nav-link">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
                    <a href="/settings" class="nav-link">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                    <a href="/logout" class="nav-link">üö™ –í—ã—Ö–æ–¥</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 style="font-size: 2.5rem; font-weight: 800; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 0 0 0.5rem 0;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏</h1>
                    <p style="color: hsl(var(--muted-foreground)); margin: 0;">–°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</p>
                </div>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="openAddManagerModal()" style="font-size: 1rem; padding: 1rem 2rem;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
                    <button class="btn" onclick="viewGeneralSchedule()" style="font-size: 1rem; padding: 1rem 2rem; background: hsl(var(--primary) / 0.1); border-color: hsl(var(--primary) / 0.3); color: hsl(var(--primary));">üìÖ –û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã</button>
                </div>
            </div>

            <!-- –ü–æ–∏—Å–∫ -->
            <div style="position: relative; margin-bottom: 1.5rem; max-width: 500px;">
                <input 
                    type="search" 
                    id="manager-search" 
                    placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º..." 
                    class="form-input"
                    style="padding: 0.875rem 1rem 0.875rem 2.75rem; width: 100%;"
                    oninput="searchManagers(this.value)"
                >
                <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: hsl(var(--muted-foreground)); pointer-events: none;">üîç</span>
            </div>

            <div class="managers-container" id="managers-container">
                <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ -->
    <div class="modal" id="manager-modal">
        <div class="modal-content">
            <h2 id="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h2>
            <form id="manager-form" onsubmit="saveManager(event)">
                <input type="hidden" id="manager-id" name="id">
                
                <div class="form-group">
                    <label class="form-label">
                        <span class="form-label-icon">üë§</span>
                        –ò–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                    </label>
                    <input type="text" class="form-input" id="manager-username" name="username" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞">
                    <span class="form-help">–ü–æ–ª–Ω–æ–µ –∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ</span>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="form-label-icon">üìß</span>
                        Email
                    </label>
                    <input type="email" class="form-input" id="manager-email" name="email" required placeholder="manager@example.com">
                    <span class="form-help">Email –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É</span>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="form-label-icon">üîí</span>
                        –ü–∞—Ä–æ–ª—å
                    </label>
                    <input type="password" class="form-input" id="manager-password" name="password" required placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6">
                    <span class="form-help">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</span>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="form-label-icon">üí∞</span>
                        –ó–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)
                    </label>
                    <input type="number" class="form-input" id="manager-salary" name="salary" min="0" step="0.01" value="0" placeholder="50000">
                    <span class="form-help">–ú–µ—Å—è—á–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</span>
                </div>

                <div style="display: flex; gap: 0.75rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1; font-size: 1rem; padding: 1rem;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="btn" onclick="closeManagerModal()" style="flex: 1; font-size: 1rem; padding: 1rem;">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let managers = [];
        let filteredManagers = [];
        let editingManagerId = null;
        let searchQuery = '';

        // –ü–æ–∏—Å–∫ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
        function searchManagers(query) {
            searchQuery = query.toLowerCase().trim();
            if (searchQuery) {
                filteredManagers = managers.filter(manager => {
                    const name = (manager.username || '').toLowerCase();
                    const email = (manager.email || '').toLowerCase();
                    return name.includes(searchQuery) || email.includes(searchQuery);
                });
            } else {
                filteredManagers = managers;
            }
            renderManagers();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        async function loadManagers() {
            try {
                const response = await fetch('/api/users');
                const allUsers = await response.json();
                managers = allUsers.filter(u => u.role === 'manager');
                filteredManagers = managers;
                renderManagers();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        async function loadManagerStats(managerId) {
            try {
                const [shiftsResponse, penaltiesResponse, activityResponse] = await Promise.all([
                    fetch('/api/shifts'),
                    fetch('/api/penalties'),
                    fetch(`/api/activity-logs?manager_id=${managerId}&limit=10`)
                ]);
                
                const shifts = await shiftsResponse.json();
                const penalties = await penaltiesResponse.json();
                const activity = await activityResponse.json();
                
                const managerShifts = shifts.filter(s => s.manager_id === managerId);
                const managerPenalties = penalties.filter(p => p.manager_id === managerId);
                
                return {
                    shifts: managerShifts.length,
                    penalties: managerPenalties.length,
                    totalPenaltyAmount: managerPenalties.reduce((sum, p) => sum + (parseFloat(p.penalty_amount) || 0), 0),
                    recentActivity: activity.length
                };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                return { shifts: 0, penalties: 0, totalPenaltyAmount: 0, recentActivity: 0 };
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        async function renderManagers() {
            const container = document.getElementById('managers-container');
            const managersToRender = searchQuery ? filteredManagers : managers;
            
            if (managersToRender.length === 0) {
                const emptyMessage = searchQuery 
                    ? '<h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3><p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>'
                    : '<h3>–ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –Ω–µ—Ç</h3><p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>';
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: hsl(var(--muted-foreground));">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">${searchQuery ? 'üîç' : 'üë•'}</div>
                        ${emptyMessage}
                    </div>
                `;
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            const managersWithStats = await Promise.all(
                managersToRender.map(async (manager) => {
                    const stats = await loadManagerStats(manager.id);
                    return { ...manager, stats };
                })
            );

            container.innerHTML = managersWithStats.map((manager, index) => {
                const delay = index * 0.05;
                const stats = manager.stats || { shifts: 0, penalties: 0, totalPenaltyAmount: 0, recentActivity: 0 };
                
                return `
                <div class="manager-card" style="animation-delay: ${delay}s;">
                    <div class="manager-header">
                        <div>
                            <div class="manager-name">${manager.username}</div>
                            <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">${manager.email}</div>
                        </div>
                        <span class="manager-status ${manager.is_active ? 'status-active' : 'status-inactive'}">
                            ${manager.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </span>
                    </div>

                    <div class="manager-info">
                        <div><strong>KPI:</strong> ${manager.kpi_score || 0}%</div>
                        <div><strong>–ó–∞—Ä–ø–ª–∞—Ç–∞:</strong> ${parseFloat(manager.salary || 0).toLocaleString('ru-RU')} ‚ÇΩ</div>
                        <div><strong>–°–æ–∑–¥–∞–Ω:</strong> ${new Date(manager.created_at).toLocaleDateString('ru-RU')}</div>
                    </div>

                    <div class="manager-stats">
                        <div class="stat-item">
                            <div class="stat-value">${stats.shifts}</div>
                            <div class="stat-label">–°–º–µ–Ω</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.penalties}</div>
                            <div class="stat-label">–®—Ç—Ä–∞—Ñ–æ–≤</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: hsl(var(--destructive));">${stats.totalPenaltyAmount.toLocaleString('ru-RU')}</div>
                            <div class="stat-label">–°—É–º–º–∞ —à—Ç—Ä–∞—Ñ–æ–≤ (‚ÇΩ)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.recentActivity}</div>
                            <div class="stat-label">–î–µ–π—Å—Ç–≤–∏–π</div>
                        </div>
                    </div>

                    <div class="manager-actions">
                        <button class="btn" onclick="viewManagerActivity(${manager.id})">üìä –î–µ–π—Å—Ç–≤–∏—è</button>
                        <button class="btn" onclick="viewManagerPenalties(${manager.id})">‚ö†Ô∏è –®—Ç—Ä–∞—Ñ—ã</button>
                        <button class="btn" onclick="editManager(${manager.id})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        ${manager.is_active ? 
                            `<button class="btn btn-danger" onclick="deactivateManager(${manager.id})">üö´ –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>` :
                            `<button class="btn btn-primary" onclick="activateManager(${manager.id})">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`
                        }
                    </div>
                </div>
            `;
            }).join('');
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        function openAddManagerModal() {
            editingManagerId = null;
            document.getElementById('modal-title').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞';
            document.getElementById('manager-form').reset();
            document.getElementById('manager-id').value = '';
            document.getElementById('manager-password').required = true;
            document.getElementById('manager-modal').classList.add('active');
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        function editManager(managerId) {
            const manager = managers.find(m => m.id === managerId);
            if (!manager) return;

            editingManagerId = managerId;
            document.getElementById('modal-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞';
            document.getElementById('manager-id').value = manager.id;
            document.getElementById('manager-username').value = manager.username;
            document.getElementById('manager-email').value = manager.email;
            document.getElementById('manager-password').value = '';
            document.getElementById('manager-password').required = false;
            document.getElementById('manager-password').placeholder = '–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å';
            document.getElementById('manager-salary').value = manager.salary || 0;
            document.getElementById('manager-modal').classList.add('active');
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        async function saveManager(event) {
            event.preventDefault();
            
            const formData = {
                username: document.getElementById('manager-username').value.trim(),
                email: document.getElementById('manager-email').value.trim(),
                salary: parseFloat(document.getElementById('manager-salary').value) || 0
            };

            const password = document.getElementById('manager-password').value.trim();
            if (password || !editingManagerId) {
                if (password.length < 6) {
                    alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                    return;
                }
                formData.password = password;
            }

            try {
                let response;
                if (editingManagerId) {
                    response = await fetch(`/api/managers/${editingManagerId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(formData)
                    });
                } else {
                    response = await fetch('/api/managers', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    closeManagerModal();
                    loadManagers();
                    showNotification(editingManagerId ? '‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω' : '‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
            }
        }

        // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        async function deactivateManager(managerId) {
            if (!confirm('–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞?')) return;

            try {
                const response = await fetch(`/api/managers/${managerId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({is_active: false})
                });

                if (response.ok) {
                    loadManagers();
                    showNotification('‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'success');
                } else {
                    alert('–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
            }
        }

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        async function activateManager(managerId) {
            try {
                const response = await fetch(`/api/managers/${managerId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({is_active: true})
                });

                if (response.ok) {
                    loadManagers();
                    showNotification('‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', 'success');
                } else {
                    alert('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
            }
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–µ–π—Å—Ç–≤–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        async function viewManagerActivity(managerId) {
            try {
                const response = await fetch(`/api/activity-logs?manager_id=${managerId}&limit=50`);
                const logs = await response.json();
                
                if (logs.length === 0) {
                    alert('–ù–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    return;
                }

                const logsText = logs.map(log => {
                    const time = new Date(log.created_at).toLocaleString('ru-RU');
                    return `${time} - ${log.action_description || log.action_type}`;
                }).join('\n');

                alert(`–î–µ–π—Å—Ç–≤–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞:\n\n${logsText}`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π');
            }
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä —à—Ç—Ä–∞—Ñ–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        async function viewManagerPenalties(managerId) {
            try {
                const response = await fetch('/api/penalties');
                const allPenalties = await response.json();
                const penalties = allPenalties.filter(p => p.manager_id === managerId);
                
                if (penalties.length === 0) {
                    alert('–£ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–µ—Ç —à—Ç—Ä–∞—Ñ–æ–≤');
                    return;
                }

                const totalAmount = penalties.reduce((sum, p) => sum + (parseFloat(p.penalty_amount) || 0), 0);
                const penaltiesText = penalties.map(p => {
                    const time = new Date(p.created_at).toLocaleString('ru-RU');
                    return `${time} - ${p.penalty_amount} ‚ÇΩ (${p.reason || p.penalty_type})`;
                }).join('\n');

                alert(`–®—Ç—Ä–∞—Ñ—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞:\n\n${penaltiesText}\n\n–í—Å–µ–≥–æ: ${totalAmount.toLocaleString('ru-RU')} ‚ÇΩ`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ç—Ä–∞—Ñ–æ–≤');
            }
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—â–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        async function viewWorkSchedule(userId, username) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
                const managersResponse = await fetch('/api/managers/list');
                const allManagers = await managersResponse.json();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –Ω–∞ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏
                const assignmentsResponse = await fetch('/api/day-managers');
                const allAssignments = await assignmentsResponse.ok ? await assignmentsResponse.json() : [];
                
                const daysOfWeek = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
                
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.id = 'schedule-modal';
                modal.style.zIndex = '10001';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <h2>üìÖ –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤</h2>
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: hsl(var(--primary) / 0.1); border-radius: calc(var(--radius)); border: 1px solid hsl(var(--primary) / 0.3);">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ÑπÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–º —Ä–∞–±–æ—Ç—ã</div>
                            <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                                –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏. –ú–æ–∂–Ω–æ –Ω–∞–∑–Ω–∞—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å.
                            </div>
                        </div>
                        <div id="schedule-form">
                            ${daysOfWeek.map((day, index) => {
                                const dayAssignments = allAssignments.filter(a => a.day_of_week === index);
                                
                                return `
                                    <div class="day-schedule-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: hsl(var(--card)); border: 2px solid hsl(var(--border)); border-radius: calc(var(--radius) + 4px);">
                                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                            <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                                                ${day}
                                            </h3>
                                            <button type="button" class="btn btn-primary" onclick="addManagerToDay(${index})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                                            </button>
                                        </div>
                                        <div id="managers-list-${index}" class="managers-list">
                                            ${dayAssignments.length > 0 ? dayAssignments.map(assignment => {
                                                const manager = allManagers.find(m => m.id === assignment.manager_id);
                                                const startTime = assignment.start_time ? assignment.start_time.substring(0, 5) : '09:00';
                                                const endTime = assignment.end_time ? assignment.end_time.substring(0, 5) : '18:00';
                                                return `
                                                    <div class="manager-assignment" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: hsl(var(--muted) / 0.3); border-radius: calc(var(--radius)); margin-bottom: 0.75rem;">
                                                        <div style="flex: 1;">
                                                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${manager ? manager.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</div>
                                                            <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                                                                <input type="time" id="start-${index}-${assignment.id}" value="${startTime}" class="form-input" style="width: 120px; display: inline-block; padding: 0.5rem;" onchange="updateManagerTime(${index}, ${assignment.id})">
                                                                <span style="margin: 0 0.5rem;">-</span>
                                                                <input type="time" id="end-${index}-${assignment.id}" value="${endTime}" class="form-input" style="width: 120px; display: inline-block; padding: 0.5rem;" onchange="updateManagerTime(${index}, ${assignment.id})">
                                                            </div>
                                                        </div>
                                                        <button type="button" class="btn btn-danger" onclick="removeManagerFromDay(${index}, ${assignment.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                                        </button>
                                                    </div>
                                                `;
                                            }).join('') : `
                                                <div style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground)); background: hsl(var(--muted) / 0.2); border-radius: calc(var(--radius));">
                                                    –ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="display: flex; gap: 0.75rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid hsl(var(--border));">
                            <button type="button" class="btn btn-primary" onclick="saveAllSchedules()" style="flex: 1; font-size: 1rem; padding: 1rem;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                            <button type="button" class="btn" onclick="closeScheduleModal()" style="flex: 1; font-size: 1rem; padding: 1rem;">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö
                window.scheduleModalData = {
                    allManagers: allManagers,
                    allAssignments: allAssignments,
                    daysOfWeek: daysOfWeek
                };
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeScheduleModal();
                    }
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã');
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–∞ –¥–µ–Ω—å
        async function addManagerToDay(dayOfWeek) {
            const data = window.scheduleModalData;
            if (!data) return;
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            const selectModal = document.createElement('div');
            selectModal.className = 'modal active';
            selectModal.style.zIndex = '10002';
            selectModal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –Ω–∞ ${data.daysOfWeek[dayOfWeek]}</h2>
                    <div style="margin-bottom: 1.5rem;">
                        <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</label>
                        <select id="manager-select" class="form-input" style="width: 100%; padding: 1rem;">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ --</option>
                            ${data.allManagers.filter(m => m.is_active).map(m => `
                                <option value="${m.id}">${m.username} (${m.email})</option>
                            `).join('')}
                        </select>
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label class="form-label">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</label>
                        <input type="time" id="new-start-time" class="form-input" value="09:00" style="width: 100%; padding: 1rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label class="form-label">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã</label>
                        <input type="time" id="new-end-time" class="form-input" value="18:00" style="width: 100%; padding: 1rem;">
                    </div>
                    <div style="display: flex; gap: 0.75rem;">
                        <button type="button" class="btn btn-primary" onclick="confirmAddManager(${dayOfWeek})" style="flex: 1; padding: 1rem;">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                        <button type="button" class="btn" onclick="closeSelectModal()" style="flex: 1; padding: 1rem;">‚ùå –û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(selectModal);
            window.currentSelectModal = selectModal;
            window.currentDayOfWeek = dayOfWeek;
        }

        async function confirmAddManager(dayOfWeek) {
            const managerId = parseInt(document.getElementById('manager-select').value);
            const startTime = document.getElementById('new-start-time').value;
            const endTime = document.getElementById('new-end-time').value;
            
            if (!managerId) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
                return;
            }
            
            try {
                const response = await fetch('/api/day-managers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        day_of_week: dayOfWeek,
                        manager_id: managerId,
                        start_time: startTime,
                        end_time: endTime
                    })
                });
                
                if (response.ok) {
                    closeSelectModal();
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
                    await reloadScheduleModal();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
            }
        }

        async function updateManagerTime(dayOfWeek, assignmentId) {
            const startTime = document.getElementById(`start-${dayOfWeek}-${assignmentId}`).value;
            const endTime = document.getElementById(`end-${dayOfWeek}-${assignmentId}`).value;
            
            const assignment = window.scheduleModalData.allAssignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            
            try {
                const response = await fetch('/api/day-managers', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        day_of_week: dayOfWeek,
                        manager_id: assignment.manager_id,
                        start_time: startTime,
                        end_time: endTime
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏');
            }
        }

        async function removeManagerFromDay(dayOfWeek, assignmentId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å?')) return;
            
            try {
                const response = await fetch(`/api/day-managers/${assignmentId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
                    await reloadScheduleModal();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞');
            }
        }

        function closeSelectModal() {
            if (window.currentSelectModal) {
                window.currentSelectModal.remove();
                window.currentSelectModal = null;
            }
        }

        async function saveAllSchedules() {
            showNotification('‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', 'success');
            closeScheduleModal();
        }

        // –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—â–µ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
        async function viewGeneralSchedule() {
            await viewWorkSchedule(0, '–û–±—â–∏–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã');
        }

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        async function reloadScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            if (!modal) return;
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const managersResponse = await fetch('/api/managers/list');
                const allManagers = await managersResponse.json();
                
                const assignmentsResponse = await fetch('/api/day-managers');
                const allAssignments = assignmentsResponse.ok ? await assignmentsResponse.json() : [];
                
                const daysOfWeek = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–æ—Ä–º—ã
                const form = document.getElementById('schedule-form');
                if (form) {
                    form.innerHTML = daysOfWeek.map((day, index) => {
                        const dayAssignments = allAssignments.filter(a => a.day_of_week === index);
                        
                        return `
                            <div class="day-schedule-card" style="margin-bottom: 1.5rem; padding: 1.5rem; background: hsl(var(--card)); border: 2px solid hsl(var(--border)); border-radius: calc(var(--radius) + 4px);">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                                        ${day}
                                    </h3>
                                    <button type="button" class="btn btn-primary" onclick="addManagerToDay(${index})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
                                    </button>
                                </div>
                                <div id="managers-list-${index}" class="managers-list">
                                    ${dayAssignments.length > 0 ? dayAssignments.map(assignment => {
                                        const manager = allManagers.find(m => m.id === assignment.manager_id);
                                        const startTime = assignment.start_time ? assignment.start_time.substring(0, 5) : '09:00';
                                        const endTime = assignment.end_time ? assignment.end_time.substring(0, 5) : '18:00';
                                        return `
                                            <div class="manager-assignment" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: hsl(var(--muted) / 0.3); border-radius: calc(var(--radius)); margin-bottom: 0.75rem;">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${manager ? manager.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</div>
                                                    <div style="font-size: 0.875rem; color: hsl(var(--muted-foreground));">
                                                        <input type="time" id="start-${index}-${assignment.id}" value="${startTime}" class="form-input" style="width: 120px; display: inline-block; padding: 0.5rem;" onchange="updateManagerTime(${index}, ${assignment.id})">
                                                        <span style="margin: 0 0.5rem;">-</span>
                                                        <input type="time" id="end-${index}-${assignment.id}" value="${endTime}" class="form-input" style="width: 120px; display: inline-block; padding: 0.5rem;" onchange="updateManagerTime(${index}, ${assignment.id})">
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-danger" onclick="removeManagerFromDay(${index}, ${assignment.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                                </button>
                                            </div>
                                        `;
                                    }).join('') : `
                                        <div style="text-align: center; padding: 2rem; color: hsl(var(--muted-foreground)); background: hsl(var(--muted) / 0.2); border-radius: calc(var(--radius));">
                                            –ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                window.scheduleModalData = {
                    allManagers: allManagers,
                    allAssignments: allAssignments,
                    daysOfWeek: daysOfWeek
                };
                
                showNotification('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function toggleWorkingDay(dayIndex) {
            const checkbox = document.getElementById(`day-${dayIndex}`);
            const startInput = document.getElementById(`start-${dayIndex}`);
            const endInput = document.getElementById(`end-${dayIndex}`);
            
            startInput.disabled = !checkbox.checked;
            endInput.disabled = !checkbox.checked;
        }

        async function saveWorkSchedule(userId) {
            const daysOfWeek = [0, 1, 2, 3, 4, 5, 6];
            const schedules = daysOfWeek.map(dayIndex => {
                const checkbox = document.getElementById(`day-${dayIndex}`);
                const isWorking = checkbox.checked;
                const startTime = document.getElementById(`start-${dayIndex}`).value;
                const endTime = document.getElementById(`end-${dayIndex}`).value;
                
                return {
                    day_of_week: dayIndex,
                    is_working_day: isWorking,
                    start_time: isWorking ? startTime : null,
                    end_time: isWorking ? endTime : null
                };
            });

            try {
                const response = await fetch('/api/work-schedules/bulk', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        schedules: schedules
                    })
                });

                if (response.ok) {
                    showNotification('‚úÖ –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
                    closeScheduleModal();
                } else {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞–±–æ—Ç—ã');
            }
        }

        function closeScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            if (modal) {
                modal.remove();
            }
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeManagerModal() {
            document.getElementById('manager-modal').classList.remove('active');
            document.getElementById('manager-password').required = true;
            document.getElementById('manager-password').placeholder = '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                padding: 1rem 1.5rem;
                border-radius: calc(var(--radius));
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
                background: hsl(var(--card));
                border: 1px solid hsl(var(--border));
                color: hsl(var(--foreground));
                font-weight: 600;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('manager-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeManagerModal();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadManagers();
        });
    </script>
</body>
</html>

