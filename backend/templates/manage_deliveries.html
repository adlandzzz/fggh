<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBGSOSAT CRM - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∞–º–∏</title>
    <link rel="stylesheet" href="/css/old-style.css">
    <style>
        * {
            box-sizing: border-box;
        }

        .manage-deliveries-container {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            font-size: 2.25rem;
            font-weight: 900;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-wrapper {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            background: hsl(var(--input));
            border: 2px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 4px);
            color: hsl(var(--foreground));
            font-size: 0.9375rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: hsl(var(--primary));
            box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: hsl(var(--muted-foreground));
            font-size: 1.125rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1.25rem;
            border: 2px solid hsl(var(--border));
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            border-radius: calc(var(--radius) + 2px);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .filter-btn:hover {
            background: hsl(var(--accent));
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .deliveries-table {
            background: hsl(var(--card));
            border: 2px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 8px);
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .table-header {
            background: linear-gradient(135deg, hsl(var(--muted) / 0.6), hsl(var(--muted) / 0.4));
            padding: 1.25rem 1.5rem;
            border-bottom: 2px solid hsl(var(--border));
            display: grid;
            grid-template-columns: 60px 1fr 150px 180px 200px 120px 100px 120px;
            gap: 1rem;
            font-weight: 800;
            font-size: 0.875rem;
            color: hsl(var(--foreground));
            align-items: center;
        }

        .table-body {
            max-height: 600px;
            overflow-y: auto;
        }

        .table-body::-webkit-scrollbar {
            width: 8px;
        }

        .table-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .table-body::-webkit-scrollbar-thumb {
            background: hsl(var(--muted-foreground) / 0.3);
            border-radius: 4px;
        }

        .table-row {
            display: grid;
            grid-template-columns: 60px 1fr 150px 180px 200px 120px 100px 120px;
            gap: 1rem;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid hsl(var(--border));
            align-items: center;
            transition: all 0.2s;
            animation: slideIn 0.3s ease-out;
        }

        .table-row:hover {
            background: hsl(var(--accent));
        }

        .table-row:last-child {
            border-bottom: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .table-cell {
            font-size: 0.9375rem;
            color: hsl(var(--foreground));
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .table-cell.client-name {
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.875rem;
            border-radius: calc(var(--radius) + 2px);
            font-size: 0.8125rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .status-processing {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .status-picking {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .status-shipped {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .status-in_transit {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .status-delivered {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .status-cancelled {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.5rem 0.875rem;
            border: 2px solid hsl(var(--border));
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            border-radius: calc(var(--radius));
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .action-btn:hover {
            background: hsl(var(--accent));
            transform: translateY(-1px);
        }

        .action-btn.edit {
            background: hsl(var(--primary) / 0.1);
            border-color: hsl(var(--primary) / 0.3);
            color: hsl(var(--primary));
        }

        .action-btn.edit:hover {
            background: hsl(var(--primary) / 0.2);
        }

        .action-btn.delete {
            background: hsl(var(--destructive) / 0.1);
            border-color: hsl(var(--destructive) / 0.3);
            color: hsl(var(--destructive));
        }

        .action-btn.delete:hover {
            background: hsl(var(--destructive) / 0.2);
        }

        .empty-state {
            padding: 4rem 2rem;
            text-align: center;
            color: hsl(var(--muted-foreground));
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            opacity: 0.3;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: hsl(var(--card));
            border: 2px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 8px);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid hsl(var(--border));
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: hsl(var(--muted-foreground));
            transition: all 0.2s;
            padding: 0.5rem;
            border-radius: calc(var(--radius));
        }

        .modal-close:hover {
            background: hsl(var(--accent));
            color: hsl(var(--foreground));
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: hsl(var(--foreground));
            font-size: 0.9375rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            background: hsl(var(--input));
            border: 2px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 2px);
            color: hsl(var(--foreground));
            font-size: 0.9375rem;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: hsl(var(--primary));
            box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid hsl(var(--border));
        }

        .btn-primary {
            padding: 0.875rem 2rem;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: calc(var(--radius) + 2px);
            cursor: pointer;
            font-weight: 700;
            font-size: 0.9375rem;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            padding: 0.875rem 2rem;
            background: hsl(var(--muted));
            color: hsl(var(--foreground));
            border: 2px solid hsl(var(--border));
            border-radius: calc(var(--radius) + 2px);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9375rem;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: hsl(var(--accent));
            transform: translateY(-2px);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            padding: 1rem 1.5rem;
            border-radius: calc(var(--radius));
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease-out;
            font-weight: 600;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .tracking-number {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: hsl(var(--primary));
            background: hsl(var(--primary) / 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: calc(var(--radius));
            font-size: 0.8125rem;
        }

        .address-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/admin/dashboard" class="logo">TBGSOSAT CRM ADMIN</a>
                <nav class="nav">
                    <span style="color: var(--muted-foreground);">üëë {{ user.username }}</span>
                    <a href="/admin/dashboard" class="nav-link">üìä –î–∞—à–±–æ—Ä–¥</a>
                    <a href="/chats" class="nav-link">üí¨ –ß–∞—Ç—ã</a>
                    <a href="/shops" class="nav-link">üè™ –ú–∞–≥–∞–∑–∏–Ω—ã</a>
                    <a href="/managers" class="nav-link">üë• –ú–µ–Ω–µ–¥–∂–µ—Ä—ã</a>
                    <a href="/deliveries" class="nav-link">üöö –î–æ—Å—Ç–∞–≤–∫–∏</a>
                    <a href="/deliveries/manage" class="nav-link active">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∞–º–∏</a>
                    <a href="/analytics" class="nav-link">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</a>
                    <a href="/settings" class="nav-link">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
                    <a href="/logout" class="nav-link">üö™ –í—ã—Ö–æ–¥</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="manage-deliveries-container">
            <div class="page-header">
                <h1 class="page-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∞–º–∏</h1>
                <div class="header-actions">
                    <button class="btn-primary" onclick="openAddModal()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É
                    </button>
                </div>
            </div>

            <div class="search-filter-bar">
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input 
                        type="search" 
                        id="search-input" 
                        class="search-input" 
                        placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É, –∞–¥—Ä–µ—Å—É, —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä—É..."
                        oninput="filterDeliveries()"
                    >
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">üìÅ –í—Å–µ</button>
                    <button class="filter-btn" data-filter="processing" onclick="setFilter('processing')">üîÑ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</button>
                    <button class="filter-btn" data-filter="picking" onclick="setFilter('picking')">üì¶ –ü–æ–¥–±–æ—Ä</button>
                    <button class="filter-btn" data-filter="shipped" onclick="setFilter('shipped')">üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
                    <button class="filter-btn" data-filter="in_transit" onclick="setFilter('in_transit')">üöö –í –ø—É—Ç–∏</button>
                    <button class="filter-btn" data-filter="delivered" onclick="setFilter('delivered')">‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</button>
                    <button class="filter-btn" data-filter="cancelled" onclick="setFilter('cancelled')">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</button>
                </div>
            </div>

            <div class="deliveries-table">
                <div class="table-header">
                    <div>ID</div>
                    <div>–ö–ª–∏–µ–Ω—Ç</div>
                    <div>–¢–µ–ª–µ—Ñ–æ–Ω</div>
                    <div>–ê–¥—Ä–µ—Å</div>
                    <div>–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä</div>
                    <div>–°—Ç–∞—Ç—É—Å</div>
                    <div>–ú–µ–Ω–µ–¥–∂–µ—Ä</div>
                    <div>–î–µ–π—Å—Ç–≤–∏—è</div>
                </div>
                <div class="table-body" id="deliveries-table-body">
                    <!-- –î–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal" id="delivery-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É</h2>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <form id="delivery-form" onsubmit="saveDelivery(event)">
                <input type="hidden" id="delivery-id" name="id">
                
                <div class="form-group">
                    <label class="form-label" for="chat-select">–ß–∞—Ç</label>
                    <select class="form-select" id="chat-select" name="chat_id">
                        <option value="">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —á–∞—Ç—É</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="status-select">–°—Ç–∞—Ç—É—Å *</label>
                    <select class="form-select" id="status-select" name="status" required>
                        <option value="processing">üîÑ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                        <option value="picking">üì¶ –ü–æ–¥–±–æ—Ä</option>
                        <option value="shipped">üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                        <option value="in_transit">üöö –í –ø—É—Ç–∏</option>
                        <option value="delivered">‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
                        <option value="cancelled">‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="address-input">–ê–¥—Ä–µ—Å</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="address-input" 
                        name="address" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="tracking-input">–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä</label>
                    <input 
                        type="text" 
                        class="form-input" 
                        id="tracking-input" 
                        name="tracking_number" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="notes-textarea">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea 
                        class="form-textarea" 
                        id="notes-textarea" 
                        name="notes" 
                        placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."
                    ></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let allDeliveries = [];
        let filteredDeliveries = [];
        let allChats = [];
        let currentFilter = 'all';
        let searchQuery = '';

        const statusLabels = {
            'processing': 'üîÑ –í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
            'picking': 'üì¶ –ü–æ–¥–±–æ—Ä',
            'shipped': 'üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
            'in_transit': 'üöö –í –ø—É—Ç–∏',
            'delivered': '‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ',
            'cancelled': '‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ'
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            await Promise.all([loadDeliveries(), loadChats()]);
        }

        async function loadDeliveries() {
            try {
                const response = await fetch('/api/deliveries');
                allDeliveries = await response.json();
                filterDeliveries();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∞–≤–æ–∫:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∞–≤–æ–∫', 'error');
            }
        }

        async function loadChats() {
            try {
                const response = await fetch('/api/chats');
                allChats = await response.json();
                updateChatSelect();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
            }
        }

        function updateChatSelect() {
            const select = document.getElementById('chat-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç...</option>';
            allChats.filter(chat => chat.status !== 'completed').forEach(chat => {
                const option = document.createElement('option');
                option.value = chat.id;
                option.textContent = `${chat.client_name} - ${chat.client_phone} (${chat.shop_name})`;
                select.appendChild(option);
            });
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterDeliveries();
        }

        function filterDeliveries() {
            searchQuery = document.getElementById('search-input').value.toLowerCase().trim();
            
            let filtered = allDeliveries;
            
            if (currentFilter !== 'all') {
                filtered = filtered.filter(d => d.delivery_status === currentFilter);
            }
            
            if (searchQuery) {
                filtered = filtered.filter(d => {
                    const name = (d.client_name || '').toLowerCase();
                    const phone = (d.client_phone || '').toLowerCase();
                    const address = (d.address || '').toLowerCase();
                    const tracking = (d.tracking_number || '').toLowerCase();
                    const notes = (d.notes || '').toLowerCase();
                    return name.includes(searchQuery) || 
                           phone.includes(searchQuery) ||
                           address.includes(searchQuery) ||
                           tracking.includes(searchQuery) ||
                           notes.includes(searchQuery);
                });
            }
            
            filteredDeliveries = filtered;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('deliveries-table-body');
            
            if (filteredDeliveries.length === 0) {
                tbody.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>–ù–µ—Ç –¥–æ—Å—Ç–∞–≤–æ–∫</h3>
                        <p>${searchQuery || currentFilter !== 'all' ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã' : '–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç–∞–≤–∫—É'}</p>
                    </div>
                `;
                return;
            }

            tbody.innerHTML = filteredDeliveries.map((delivery, index) => {
                const statusClass = `status-${delivery.delivery_status}`;
                const statusLabel = statusLabels[delivery.delivery_status] || delivery.delivery_status;
                const createdDate = new Date(delivery.created_at).toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                return `
                    <div class="table-row" style="animation-delay: ${index * 0.03}s;">
                        <div class="table-cell">#${delivery.id}</div>
                        <div class="table-cell client-name">${delivery.client_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                        <div class="table-cell">${delivery.client_phone || '–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞'}</div>
                        <div class="table-cell address-cell" title="${delivery.address || ''}">${delivery.address || '‚Äî'}</div>
                        <div class="table-cell">
                            ${delivery.tracking_number ? `<span class="tracking-number">${delivery.tracking_number}</span>` : '‚Äî'}
                        </div>
                        <div class="table-cell">
                            <span class="status-badge ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="table-cell">${delivery.manager_name || '‚Äî'}</div>
                        <div class="table-cell">
                            <div class="action-buttons">
                                <button class="action-btn edit" onclick="openEditModal(${delivery.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    ‚úèÔ∏è
                                </button>
                                <button class="action-btn delete" onclick="deleteDelivery(${delivery.id})" title="–£–¥–∞–ª–∏—Ç—å">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddModal() {
            document.getElementById('modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É';
            document.getElementById('delivery-form').reset();
            document.getElementById('delivery-id').value = '';
            document.getElementById('delivery-modal').classList.add('active');
        }

        function openEditModal(deliveryId) {
            const delivery = allDeliveries.find(d => d.id === deliveryId);
            if (!delivery) return;

            document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É';
            document.getElementById('delivery-id').value = delivery.id;
            document.getElementById('chat-select').value = delivery.chat_id || '';
            document.getElementById('status-select').value = delivery.delivery_status;
            document.getElementById('address-input').value = delivery.address || '';
            document.getElementById('tracking-input').value = delivery.tracking_number || '';
            document.getElementById('notes-textarea').value = delivery.notes || '';
            document.getElementById('delivery-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('delivery-modal').classList.remove('active');
        }

        async function saveDelivery(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const deliveryId = formData.get('id');
            const chatIdValue = formData.get('chat_id');
            const data = {
                status: formData.get('status'),
                address: formData.get('address') || null,
                tracking_number: formData.get('tracking_number') || null,
                notes: formData.get('notes') || null
            };
            
            if (chatIdValue) {
                data.chat_id = parseInt(chatIdValue);
            }

            try {
                let response;
                if (deliveryId) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                    response = await fetch(`/api/deliveries/${deliveryId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ
                    response = await fetch('/api/deliveries', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    showNotification(deliveryId ? '‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞' : '‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
                    closeModal();
                    await loadDeliveries();
                } else {
                    const error = await response.json();
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            }
        }

        async function deleteDelivery(deliveryId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–æ—Å—Ç–∞–≤–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

            try {
                const response = await fetch(`/api/deliveries/${deliveryId}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'}
                });

                if (response.ok) {
                    showNotification('‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                    await loadDeliveries();
                } else {
                    const error = await response.json();
                    showNotification('‚ùå –û—à–∏–±–∫–∞: ' + (error.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å'), 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.getElementById('delivery-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setInterval(loadDeliveries, 30000);
        });
    </script>
</body>
</html>

